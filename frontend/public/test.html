<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
      color: #111827;
    }

    .shipping-page {
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    .shipping-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .page-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .page-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 0.5rem;
    }

    .page-header p {
      color: #6b7280;
      font-size: 1rem;
    }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .map-section {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .section-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .section-header svg {
      width: 1.5rem;
      height: 1.5rem;
      color: #2563eb;
    }

    .section-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
    }

    .search-wrapper {
      padding: 1rem 1.5rem;
      background-color: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }

    .search-container {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 0.875rem 1rem 0.875rem 3rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      width: 1.25rem;
      height: 1.25rem;
      color: #6b7280;
      pointer-events: none;
    }

    .suggestions-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      list-style: none;
    }

    .suggestion-item {
      padding: 0.875rem 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
      border-bottom: 1px solid #f3f4f6;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover {
      background-color: #f3f4f6;
    }

    #map {
      height: 500px;
      width: 100%;
    }

    .form-section {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .form-label .required {
      color: #dc2626;
      margin-left: 0.25rem;
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }

    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .info-box {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .info-box-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .info-box-header svg {
      width: 1.25rem;
      height: 1.25rem;
      color: #2563eb;
    }

    .info-box-header h3 {
      font-size: 0.875rem;
      font-weight: 600;
      color: #1e40af;
    }

    .info-content {
      font-size: 0.875rem;
      color: #1e40af;
      line-height: 1.5;
    }

    .shipping-info {
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      display: none;
    }

    .shipping-info.active {
      display: block;
    }

    .shipping-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #bbf7d0;
    }

    .shipping-info-row:last-child {
      border-bottom: none;
    }

    .shipping-info-label {
      font-size: 0.875rem;
      color: #15803d;
      font-weight: 500;
    }

    .shipping-info-value {
      font-size: 0.875rem;
      color: #166534;
      font-weight: 600;
    }

    .submit-btn {
      width: 100%;
      padding: 1rem 1.5rem;
      background-color: #2563eb;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      border: none;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .submit-btn:hover:not(:disabled) {
      background-color: #1d4ed8;
    }

    .submit-btn:disabled {
      background-color: #d1d5db;
      cursor: not-allowed;
    }

    .leaflet-popup-content-wrapper {
      border-radius: 0.5rem;
    }

    @media (min-width: 1024px) {
      .content-grid {
        grid-template-columns: 2fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .page-header h1 {
        font-size: 1.5rem;
      }

      #map {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="shipping-page">
    <div class="shipping-container">
      <div class="page-header">
        <h1>üìç Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng</h1>
        <p>T√¨m ki·∫øm v√† ch·ªçn ƒë·ªãa ch·ªâ ch√≠nh x√°c tr√™n b·∫£n ƒë·ªì</p>
      </div>

      <div class="content-grid">
        <!-- Map Section -->
        <div class="map-section">
          <div class="section-header">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
            <h2>B·∫£n ƒë·ªì</h2>
          </div>

          <div class="search-wrapper">
            <div class="search-container">
              <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <input 
                type="text" 
                id="addrInput" 
                class="search-input" 
                placeholder="T√¨m ki·∫øm ƒë·ªãa ch·ªâ (VD: 123 Tr·∫ßn H∆∞ng ƒê·∫°o, Qu·∫≠n 1, TP.HCM)"
              />
              <ul id="suggestions" class="suggestions-list"></ul>
            </div>
          </div>

          <div id="map"></div>
        </div>

        <!-- Form Section -->
        <div>
          <div class="form-section">
            <div class="section-header" style="padding: 0 0 1rem 0; border: none;">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <h2>Th√¥ng tin ng∆∞·ªùi nh·∫≠n</h2>
            </div>

            <form id="shippingForm">
              <div class="form-group">
                <label class="form-label">
                  H·ªç v√† t√™n<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  id="fullName" 
                  class="form-input" 
                  placeholder="Nguy·ªÖn VƒÉn A"
                  required
                />
              </div>

              <div class="form-group">
                <label class="form-label">
                  S·ªë ƒëi·ªán tho·∫°i<span class="required">*</span>
                </label>
                <input 
                  type="tel" 
                  id="phone" 
                  class="form-input" 
                  placeholder="0123456789"
                  pattern="[0-9]{10,11}"
                  required
                />
              </div>

              <div class="form-group">
                <label class="form-label">
                  ƒê·ªãa ch·ªâ chi ti·∫øt<span class="required">*</span>
                </label>
                <textarea 
                  id="detailAddress" 
                  class="form-textarea" 
                  placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, khu v·ª±c..."
                  required
                ></textarea>
              </div>

              <div class="info-box">
                <div class="info-box-header">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <h3>G·ª£i √Ω</h3>
                </div>
                <div class="info-content">
                  T√¨m ki·∫øm ƒë·ªãa ch·ªâ tr√™n b·∫£n ƒë·ªì v√† k√©o marker ƒë·ªÉ ƒëi·ªÅu ch·ªânh v·ªã tr√≠ ch√≠nh x√°c
                </div>
              </div>

              <div class="shipping-info" id="shippingInfo">
                <div class="shipping-info-row">
                  <span class="shipping-info-label">T·ªânh/Th√†nh ph·ªë:</span>
                  <span class="shipping-info-value" id="provinceName">-</span>
                </div>
                <div class="shipping-info-row">
                  <span class="shipping-info-label">Qu·∫≠n/Huy·ªán:</span>
                  <span class="shipping-info-value" id="districtName">-</span>
                </div>
                <div class="shipping-info-row">
                  <span class="shipping-info-label">D·ªãch v·ª• v·∫≠n chuy·ªÉn:</span>
                  <span class="shipping-info-value" id="serviceName">-</span>
                </div>
                <div class="shipping-info-row">
                  <span class="shipping-info-label">üöö Ph√≠ v·∫≠n chuy·ªÉn:</span>
                  <span class="shipping-info-value" id="shippingFee" style="color: #dc2626; font-size: 1.125rem;">-</span>
                </div>
              </div>

              <button type="submit" class="submit-btn">
                X√°c nh·∫≠n ƒë·ªãa ch·ªâ giao h√†ng
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const GHN_TOKEN = "6b59f4d3-8b36-11f0-87a6-b6731eee7e4b";
    let SHOP_INFO = null;
    let currentShippingInfo = {};

    // DOM Elements
    const input = document.getElementById('addrInput');
    const suggestions = document.getElementById('suggestions');
    const searchContainer = document.querySelector('.search-container');
    let timeoutId = null;

    // Initialize map
    var map = L.map('map').setView([10.762622, 106.660172], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    let searchMarker = null;

    // Get shop info
    async function getShopInfo() {
      try {
        let res = await fetch("https://online-gateway.ghn.vn/shiip/public-api/v2/shop/all", {
          headers: { "Token": GHN_TOKEN }
        });
        let data = await res.json();
        if (data.data && data.data.shops.length > 0) {
          SHOP_INFO = data.data.shops.find(s => s.district_id !== 0);
          console.log("Shop Info:", SHOP_INFO);
        }
      } catch (err) {
        console.error("Error getting shop info:", err);
      }
    }

    // Address search
    input.addEventListener('input', function() {
      clearTimeout(timeoutId);
      const value = this.value.trim();
      
      if (!value) {
        suggestions.innerHTML = '';
        return;
      }

      timeoutId = setTimeout(async () => {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(value)}&format=json&addressdetails=1&limit=5`);
          const data = await res.json();
          
          suggestions.innerHTML = '';
          
          data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'suggestion-item';
            li.textContent = item.display_name;
            li.addEventListener('click', () => {
              input.value = item.display_name;
              document.getElementById('detailAddress').value = item.display_name;
              suggestions.innerHTML = '';
              placeMarker(item.lat, item.lon, item.display_name);
              matchWithGHN(item.display_name);
            });
            suggestions.appendChild(li);
          });
        } catch(e) {
          console.error("Search error:", e);
        }
      }, 500);
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!searchContainer.contains(e.target)) {
        suggestions.innerHTML = '';
      }
    });

    // Place marker on map
    function placeMarker(lat, lon, name) {
      if (!searchMarker) {
        searchMarker = L.marker([lat, lon], { draggable: true })
          .addTo(map)
          .bindPopup(name)
          .openPopup();

        searchMarker.on('dragend', async function(e) {
          const pos = e.target.getLatLng();
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pos.lat}&lon=${pos.lng}&format=json`);
            const data = await res.json();
            
            input.value = data.display_name;
            document.getElementById('detailAddress').value = data.display_name;
            searchMarker.bindPopup(data.display_name).openPopup();
            
            matchWithGHN(data.display_name);
          } catch (err) {
            console.error("Reverse geocoding error:", err);
          }
        });
      } else {
        searchMarker.setLatLng([lat, lon])
          .bindPopup(name)
          .openPopup();
      }
      map.setView([lat, lon], 16);
    }

    // Get current location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        L.marker([lat, lon], { 
          icon: L.icon({
            iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          })
        }).addTo(map).bindPopup("üìç V·ªã tr√≠ c·ªßa b·∫°n").openPopup();
      }, err => {
        console.error("Geolocation error:", err);
      });
    }

    // Utility functions
    function removeVietnameseTones(str) {
      return str.normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/ƒë/g, "d").replace(/ƒê/g, "D");
    }

    function normalizeDistrictName(name) {
      return removeVietnameseTones(
        name.toLowerCase()
          .replace("huyen", "")
          .replace("quan", "")
          .replace("thanh pho", "")
          .replace("tp.", "")
          .replace("thi xa", "")
          .replace("phuong", "")
          .trim()
      );
    }

    function extractDistrictFromOSM(addr) {
      let txt = removeVietnameseTones(addr.toLowerCase());
      let districtMatch = txt.match(/(huyen|quan|thi xa|tp|thanh pho|phuong)\s+([a-z\s]+)/);
      
      if (districtMatch) {
        return districtMatch[2].trim().replace(/[,\.]/g, "");
      }

      let provinceIndex = txt.indexOf("tinh");
      if (provinceIndex > 0) {
        let beforeProvince = txt.substring(0, provinceIndex).trim();
        let parts = beforeProvince.split(" ");
        if (parts.length >= 2) {
          return parts.slice(-2).join(" ").replace(/[,\.]/g, "");
        }
      }

      return null;
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
      }).format(amount);
    }

    // Match address with GHN
    async function matchWithGHN(addressText) {
      try {
        let cleanAddr = removeVietnameseTones(addressText.toLowerCase());

        // Get province
        let provRes = await fetch("https://online-gateway.ghn.vn/shiip/public-api/master-data/province", {
          headers: { "Token": GHN_TOKEN }
        });
        let provData = await provRes.json();

        let province = provData.data.find(p =>
          cleanAddr.includes(removeVietnameseTones(p.ProvinceName.toLowerCase()))
        );
        
        if (!province) {
          console.log("Province not found");
          return;
        }

        currentShippingInfo.province = province;
        document.getElementById('provinceName').textContent = province.ProvinceName;

        // Get district
        let distRes = await fetch("https://online-gateway.ghn.vn/shiip/public-api/master-data/district", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Token": GHN_TOKEN },
          body: JSON.stringify({ province_id: province.ProvinceID })
        });
        let distData = await distRes.json();
        
        let districtGuess = extractDistrictFromOSM(addressText);
        let district = null;
        
        if (districtGuess) {
          district = distData.data.find(d =>
            normalizeDistrictName(d.DistrictName).includes(districtGuess)
          );
        }
        
        if (!district) {
          district = distData.data.find(d =>
            cleanAddr.includes(removeVietnameseTones(d.DistrictName.toLowerCase()))
          );
        }

        if (district) {
          currentShippingInfo.district = district;
          document.getElementById('districtName').textContent = district.DistrictName;
          document.getElementById('shippingInfo').classList.add('active');

          if (SHOP_INFO) {
            await getAvailableServices(SHOP_INFO._id, SHOP_INFO.district_id, district.DistrictID, SHOP_INFO.ward_code);
          }
        }
      } catch (err) {
        console.error("GHN matching error:", err);
      }
    }

    // Get available services
    async function getAvailableServices(shopId, fromDistrict, toDistrict, fromWardCode) {
      try {
        let res = await fetch("https://online-gateway.ghn.vn/shiip/public-api/v2/shipping-order/available-services", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Token": GHN_TOKEN },
          body: JSON.stringify({
            shop_id: shopId,
            from_district: fromDistrict,
            to_district: toDistrict
          })
        });
        let data = await res.json();

        if (data.data && data.data.length > 0) {
          let service = data.data[0];
          currentShippingInfo.service = service;
          document.getElementById('serviceName').textContent = service.short_name;

          await getShipFee(fromDistrict, fromWardCode, toDistrict, service.service_id);
        }
      } catch (err) {
        console.error("Service error:", err);
      }
    }

    // Calculate shipping fee
    async function getShipFee(fromDistrict, fromWard, toDistrict, serviceId) {
      try {
        let res = await fetch("https://online-gateway.ghn.vn/shiip/public-api/v2/shipping-order/fee", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Token": GHN_TOKEN },
          body: JSON.stringify({
            from_district_id: fromDistrict,
            from_ward_code: fromWard,
            to_district_id: toDistrict,
            to_ward_code: "",
            service_id: serviceId,
            weight: 300,
            length: 30,
            width: 20,
            height: 5
          })
        });
        let data = await res.json();

        if (data.data) {
          currentShippingInfo.fee = data.data.total;
          document.getElementById('shippingFee').textContent = formatCurrency(data.data.total);
        }
      } catch (err) {
        console.error("Fee calculation error:", err);
      }
    }

    // Form submission
    document.getElementById('shippingForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = {
        fullName: document.getElementById('fullName').value,
        phone: document.getElementById('phone').value,
        detailAddress: document.getElementById('detailAddress').value,
        shippingInfo: currentShippingInfo
      };

      console.log("Form submitted:", formData);
      alert(`Th√¥ng tin ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n!\n\nH·ªç t√™n: ${formData.fullName}\nSƒêT: ${formData.phone}\nƒê·ªãa ch·ªâ: ${formData.detailAddress}\nPh√≠ ship: ${formatCurrency(currentShippingInfo.fee || 0)}`);
    });

    // Initialize
    getShopInfo();
  </script>
</body>
</html>