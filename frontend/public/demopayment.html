<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PayPal Sandbox VND → USD Demo</title>
  <script src="https://www.paypal.com/sdk/js?client-id=Af37P1fTOc_4eTMaNyALE4LHuTGgPA093G-V6gwAryBTVN_EvswbY0Mlz513LA-L92SYXtcvyH_iU5V-&currency=USD"></script>
</head>
<body>
  <h3>Thanh toán PayPal Sandbox</h3>
  <label>Nhập số tiền VND: <input type="number" id="amountVND" value="100000"/></label>
  <div id="paypal-button-container"></div>

  <script>
    async function getVNDtoUSDRate() {
        try {
            const res = await fetch("https://open.er-api.com/v6/latest/VND");
            const data = await res.json();
            return data.rates.USD;
        } catch(err) {
            console.error("Lỗi lấy tỷ giá:", err);
            return null;
        }
    }

    paypal.Buttons({
      createOrder: async function(data, actions) {
        const vndAmount = parseFloat(document.getElementById('amountVND').value);
        const rate = await getVNDtoUSDRate();
        if (!rate) {
          alert("Không lấy được tỷ giá!");
          return;
        }
        const usdAmount = (vndAmount * rate).toFixed(2);

        return actions.order.create({
          purchase_units: [{
            amount: {
              value: usdAmount,
              currency_code: "USD"
            }
          }]
        });
      },
      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
            if(details.status === "COMPLETED") {
                alert("Thanh toán thành công!\nNgười thanh toán: " + details.payer.name.given_name +
                    "\nSố tiền USD: " + details.purchase_units[0].amount.value);
            } else {
                alert("Thanh toán chưa hoàn tất. Trạng thái: " + details.status);
            }
        });
      }
    }).render('#paypal-button-container');
  </script>
</body>
</html>
